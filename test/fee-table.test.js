const { expect } = require("chai");
const Scalar = require("ffjavascript").Scalar;

const float40 = require("../index").float40;
const { computeFee, tableAdjustedFee } = require("../index").feeTable;

describe("Fee table", function () {

    it("Compute fee standard", async () => {
        // standard fee computation
        const testVector = [
            ["0", "0"],
            ["1", "2"],
            ["2", "7"],
            ["3", "25"],
            ["4", "78"],
            ["5", "241"],
            ["6", "746"],
            ["7", "2302"],
            ["8", "7105"],
            ["9", "21915"],
            ["10", "67597"],
            ["11", "208502"],
            ["12", "643109"],
            ["13", "1983621"],
            ["14", "6118326"],
            ["15", "18871498"],
            ["16", "58207660"],
            ["17", "179536969"],
            ["18", "553767715"],
            ["19", "1708053132"],
            ["20", "5268356063"],
            ["21", "16249831507"],
            ["22", "50121332123"],
            ["23", "154595321971"],
            ["24", "476837158203"],
            ["25", "1470766854675"],
            ["26", "4536465129862"],
            ["27", "13992371264719"],
            ["28", "43158372875154"],
            ["29", "133118619710113"],
            ["30", "410593952760602"],
            ["31", "1266444877588875"],
            ["32", "3906250000000000"],
            ["33", "4044003608755380"],
            ["34", "4186615088032394"],
            ["35", "4334255750265020"],
            ["36", "4487102949207168"],
            ["37", "4645340292979379"],
            ["38", "4809157864628578"],
            ["39", "4978752450465866"],
            ["40", "5154327776456619"],
            ["41", "5336094752946858"],
            ["42", "5524271728019902"],
            ["43", "5719084749787598"],
            ["44", "5920767837931241"],
            ["45", "6129563264818366"],
            ["46", "6345721846533090"],
            ["47", "6569503244169645"],
            ["48", "6801176275750968"],
            ["49", "7041019239147109"],
            ["50", "7289320246381309"],
            ["51", "7546377569725357"],
            ["52", "7812500000000000"],
            ["53", "8088007217510760"],
            ["54", "8373230176064788"],
            ["55", "8668511500530041"],
            ["56", "8974205898414336"],
            ["57", "9290680585958758"],
            ["58", "9618315729257156"],
            ["59", "9957504900931732"],
            ["60", "10308655552913239"],
            ["61", "10672189505893716"],
            ["62", "11048543456039804"],
            ["63", "11438169499575196"],
            ["64", "11841535675862482"],
            ["65", "12259126529636732"],
            ["66", "12691443693066181"],
            ["67", "13139006488339290"],
            ["68", "13602352551501937"],
            ["69", "14082038478294218"],
            ["70", "14578640492762619"],
            ["71", "15092755139450714"],
            ["72", "15625000000000000"],
            ["73", "16176014435021531"],
            ["74", "16746460352129576"],
            ["75", "17337023001060082"],
            ["76", "17948411796828673"],
            ["77", "18581361171917516"],
            ["78", "19236631458514327"],
            ["79", "19915009801863465"],
            ["80", "20617311105826478"],
            ["81", "21344379011787432"],
            ["82", "22097086912079608"],
            ["83", "22876338999150411"],
            ["84", "23683071351724965"],
            ["85", "24518253059273464"],
            ["86", "25382887386132362"],
            ["87", "26278012976678581"],
            ["88", "27204705103003892"],
            ["89", "28164076956588436"],
            ["90", "29157280985525238"],
            ["91", "30185510278901428"],
            ["92", "31250000000000000"],
            ["93", "32352028870043063"],
            ["94", "33492920704259153"],
            ["95", "34674046002120165"],
            ["96", "35896823593657346"],
            ["97", "37162722343835032"],
            ["98", "38473262917028655"],
            ["99", "39830019603726930"],
            ["100", "41234622211652957"],
            ["101", "42688758023574864"],
            ["102", "44194173824159216"],
            ["103", "45752677998300822"],
            ["104", "47366142703449930"],
            ["105", "49036506118546929"],
            ["106", "50765774772264724"],
            ["107", "52556025953357163"],
            ["108", "54409410206007785"],
            ["109", "56328153913176873"],
            ["110", "58314561971050477"],
            ["111", "60371020557802856"],
            ["112", "62500000000000000"],
            ["113", "64704057740086085"],
            ["114", "66985841408518348"],
            ["115", "69348092004240330"],
            ["116", "71793647187314693"],
            ["117", "74325444687670064"],
            ["118", "76946525834057255"],
            ["119", "79660039207453917"],
            ["120", "82469244423305915"],
            ["121", "85377516047149729"],
            ["122", "88388347648318432"],
            ["123", "91505355996601575"],
            ["124", "94732285406899915"],
            ["125", "98073012237093859"],
            ["126", "101531549544529448"],
            ["127", "105112051906714326"],
            ["128", "108818820412015571"],
            ["129", "112656307826353829"],
            ["130", "116629123942100954"],
            ["131", "120742041115605713"],
            ["132", "125000000000000000"],
            ["133", "129408115480172253"],
            ["134", "133971682817036696"],
            ["135", "138696184008480660"],
            ["136", "143587294374629387"],
            ["137", "148650889375340128"],
            ["138", "153893051668114622"],
            ["139", "159320078414907834"],
            ["140", "164938488846611830"],
            ["141", "170755032094299458"],
            ["142", "176776695296636865"],
            ["143", "183010711993203289"],
            ["144", "189464570813799831"],
            ["145", "196146024474187719"],
            ["146", "203063099089058896"],
            ["147", "210224103813428653"],
            ["148", "217637640824031142"],
            ["149", "225312615652707659"],
            ["150", "233258247884201908"],
            ["151", "241484082231211427"],
            ["152", "250000000000000000"],
            ["153", "258816230960344506"],
            ["154", "267943365634073393"],
            ["155", "277392368016961321"],
            ["156", "287174588749258774"],
            ["157", "297301778750680256"],
            ["158", "307786103336229244"],
            ["159", "318640156829815668"],
            ["160", "329876977693223660"],
            ["161", "341510064188598916"],
            ["162", "353553390593273730"],
            ["163", "366021423986406579"],
            ["164", "378929141627599663"],
            ["165", "392292048948375438"],
            ["166", "406126198178117792"],
            ["167", "420448207626857306"],
            ["168", "435275281648062284"],
            ["169", "450625231305415319"],
            ["170", "466516495768403816"],
            ["171", "482968164462422855"],
            ["172", "500000000000000000"],
            ["173", "517632461920689013"],
            ["174", "535886731268146787"],
            ["175", "554784736033922643"],
            ["176", "574349177498517549"],
            ["177", "594603557501360513"],
            ["178", "615572206672458488"],
            ["179", "637280313659631336"],
            ["180", "659753955386447321"],
            ["181", "683020128377197832"],
            ["182", "707106781186547461"],
            ["183", "732042847972813159"],
            ["184", "757858283255199327"],
            ["185", "784584097896750876"],
            ["186", "812252396356235584"],
            ["187", "840896415253714613"],
            ["188", "870550563296124568"],
            ["189", "901250462610830638"],
            ["190", "933032991536807632"],
            ["191", "965936328924845710"],
            ["192", "1000000000000000000"],
            ["193", "2000000000000000000"],
            ["194", "4000000000000000000"],
            ["195", "8000000000000000000"],
            ["196", "16000000000000000000"],
            ["197", "32000000000000000000"],
            ["198", "64000000000000000000"],
            ["199", "128000000000000000000"],
            ["200", "256000000000000000000"],
            ["201", "512000000000000000000"],
            ["202", "1024000000000000000000"],
            ["203", "2048000000000000000000"],
            ["204", "4096000000000000000000"],
            ["205", "8192000000000000000000"],
            ["206", "16384000000000000000000"],
            ["207", "32768000000000000000000"],
            ["208", "65536000000000000000000"],
            ["209", "131072000000000000000000"],
            ["210", "262144000000000000000000"],
            ["211", "524288000000000000000000"],
            ["212", "1048576000000000000000000"],
            ["213", "2097152000000000000000000"],
            ["214", "4194304000000000000000000"],
            ["215", "8388608000000000000000000"],
            ["216", "16777216000000000000000000"],
            ["217", "33554432000000000000000000"],
            ["218", "67108864000000000000000000"],
            ["219", "134217728000000000000000000"],
            ["220", "268435456000000000000000000"],
            ["221", "536870912000000000000000000"],
            ["222", "1073741824000000000000000000"],
            ["223", "2147483648000000000000000000"],
            ["224", "4294967296000000000000000000"],
            ["225", "8589934592000000000000000000"],
            ["226", "17179869184000000000000000000"],
            ["227", "34359738368000000000000000000"],
            ["228", "68719476736000000000000000000"],
            ["229", "137438953472000000000000000000"],
            ["230", "274877906944000000000000000000"],
            ["231", "549755813888000000000000000000"],
            ["232", "1099511627776000000000000000000"],
            ["233", "2199023255552000000000000000000"],
            ["234", "4398046511104000000000000000000"],
            ["235", "8796093022208000000000000000000"],
            ["236", "17592186044416000000000000000000"],
            ["237", "35184372088832000000000000000000"],
            ["238", "70368744177664000000000000000000"],
            ["239", "140737488355328000000000000000000"],
            ["240", "281474976710656000000000000000000"],
            ["241", "562949953421312000000000000000000"],
            ["242", "1125899906842624000000000000000000"],
            ["243", "2251799813685248000000000000000000"],
            ["244", "4503599627370496000000000000000000"],
            ["245", "9007199254740992000000000000000000"],
            ["246", "18014398509481984000000000000000000"],
            ["247", "36028797018963968000000000000000000"],
            ["248", "72057594037927936000000000000000000"],
            ["249", "144115188075855872000000000000000000"],
            ["250", "288230376151711744000000000000000000"],
            ["251", "576460752303423488000000000000000000"],
            ["252", "1152921504606846976000000000000000000"],
            ["253", "2305843009213693952000000000000000000"],
            ["254", "4611686018427387904000000000000000000"],
            ["255", "9223372036854775808000000000000000000"],
        ];

        const amount = Scalar.e(10**18);

        for (let i = 0; i < testVector.length; i++){
            const feeSelector = testVector[i][0];
            const expectedValue = testVector[i][1];

            let fee2apply = computeFee(amount, feeSelector);
            expect(expectedValue).to.be.equal(fee2apply.toString());
        }
    });

    it("Compute fee error fee selected", () =>{
        const amount = Scalar.e(10**18);
        const nonExistingFeeSelected = 257;
        try {
            computeFee(amount, nonExistingFeeSelected);
            expect(true).to.be.equal(false);
        } catch (error){
            expect(error.message.includes("Fee selected does not exist")).to.be.equal(true);
        }
    });

    it("Compute fee error greater than 128", () =>{
        const amountMaxTransfer = float40.float2Fix(0xF8000002FF);
        // This selected fee is the minimal fee to get an applied fee over 128 bits
        const selectedFee = 208;

        // manual fee computation
        const manualFeeApplied = Scalar.mul(amountMaxTransfer, tableAdjustedFee[selectedFee]);
        expect(Scalar.bitLength(manualFeeApplied)).to.be.greaterThan(128);

        const fee2Apply = computeFee(amountMaxTransfer, selectedFee - 1);
        expect(Scalar.bitLength(fee2Apply)).to.be.equal(128);

        try {
            computeFee(amountMaxTransfer, selectedFee);
        } catch(error){
            expect(error.message.includes("Applied fee could not be greater than 128 bits"))
                .to.be.equal(true);
        }
    });
});
